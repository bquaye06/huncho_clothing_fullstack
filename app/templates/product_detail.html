{% extends 'base.html' %}
{% block title %}{{ product.name }} | HunchØ.clothing{% endblock %}
{% block content %}

<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <!-- metadata for JS (product id) -->
  <div id="productMeta"
    data-product-id="{{ product.product_id or 0 }}"
    data-product-name="{{ (product.name or '')|e }}"
    data-product-price="{{ '%.2f'|format(product.price) if product.price is not none else '' }}"
    data-product-image="{% if product.image_url %}{{ product.image_url }}{% else %}{{ url_for('static', filename='images/dress.webp') }}{% endif %}"
    class="sr-only" aria-hidden="true"></div>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 items-start">

    <!-- Left: Small meta (SKU, short desc) -->
    <div class="order-2 lg:order-1 lg:col-span-1">
      <div class="text-sm text-gray-500 mb-6">SKU: <span class="text-gray-700 font-medium">{{ product.product_id or 'N/A' }}</span></div>
      <h1 class="text-xl lg:text-2xl font-semibold text-gray-900 mb-4">{{ product.name }}</h1>
      <p class="text-sm text-gray-600 mb-6">{{ product.description or "No description available." }}</p>

      {% if product.brand %}
      <div class="mb-4"><span class="text-xs text-gray-500">Brand</span><div class="text-sm font-medium">{{ product.brand }}</div></div>
      {% endif %}

      {% if product.color %}
      <div class="mb-4"><span class="text-xs text-gray-500">Color</span><div class="text-sm font-medium">{{ product.color }}</div></div>
      {% endif %}
    </div>

    <!-- Center: Main image + thumbnails -->
    <div class="order-1 lg:order-2 lg:col-span-1 flex flex-col items-center">
      <div class="w-full max-w-lg">
        {% set imgval = (product.image_url or '') %}
        {% if imgval.startswith('http') or imgval.startswith('/') %}
          <img id="mainProductImage" src="{{ imgval if imgval else url_for('static', filename='images/dress.webp') }}" alt="{{ product.name }}" class="w-full h-[520px] object-contain rounded-lg bg-white p-6 shadow" onerror="this.onerror=null;this.src='/static/images/dress.webp'" />
        {% else %}
          <img id="mainProductImage" src="{{ url_for('static', filename='images/products/' ~ (imgval if imgval else 'dress.webp')) }}" alt="{{ product.name }}" class="w-full h-[520px] object-contain rounded-lg bg-white p-6 shadow" onerror="this.onerror=null;this.src='/static/images/dress.webp'" />
        {% endif %}
      </div>

      <div class="mt-6 w-full max-w-lg flex items-center gap-3 justify-center">
        {# thumbnails: primary image + two fallbacks (if available) #}
        {% set thumb1 = imgval %}
        {% set thumb2 = '/static/images/dress.webp' %}
        {% set thumb3 = url_for('static', filename='images/logo_2.png') %}

        {% for t in [thumb1, thumb2, thumb3] %}
          {% if t %}
            <button type="button" class="thumbnail-btn border rounded p-1 bg-white" data-src="{{ t }}">
              <img src="{{ t }}" alt="thumb" class="w-16 h-16 object-contain" onerror="this.onerror=null;this.src='/static/images/dress.webp'" />
            </button>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- Right: Purchase controls -->
    <div class="order-3 lg:col-span-1">
      <div class="flex items-center justify-between">
        <div>
          {% if product.original_price and product.original_price > product.price %}
            <div class="text-sm text-gray-500 line-through">₵{{ '%.2f'|format(product.original_price) }}</div>
            <div class="text-2xl font-extrabold text-gray-900">₵{{ '%.2f'|format(product.price) }}</div>
          {% else %}
            <div class="text-2xl font-extrabold text-gray-900">₵{{ '%.2f'|format(product.price) }}</div>
          {% endif %}
        </div>
        <div class="text-xs text-gray-500">{{ 'In stock' if product.stock and product.stock > 0 else 'Out of stock' }}</div>
      </div>

      <div class="mt-6">
        <div class="text-xs text-gray-500 mb-2">COLOR</div>
        <div class="flex items-center gap-3">
          {# if you have color swatches, render them; otherwise show one #}
          <div class="w-8 h-8 rounded-full border flex items-center justify-center" title="{{ product.color or 'Color' }}">
            <div class="w-6 h-6 rounded-full bg-black"></div>
          </div>
          <div class="text-sm font-medium">{{ product.color or 'Black' }}</div>
        </div>
      </div>

      <div class="mt-6">
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500">SIZE</div>
          <a href="#" class="text-xs text-gray-400">SIZE GUIDE</a>
        </div>

        {% set sizes = ['XS','S','M','L','XL','XXL'] %}
        {% set avail = product.size.split(',') if product.size else sizes %}
        <div class="mt-3">
          {# Accessible label + instructions for screen readers #}
          <div id="sizeGroupLabel" class="sr-only">Available sizes. Use arrow keys to navigate and press Enter or Space to select.</div>
          <div id="sizeAnnouncer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
          <div class="grid grid-cols-3 gap-3" role="radiogroup" aria-labelledby="sizeGroupLabel">
            {% set first_avail = true %}
            {% for s in sizes %}
                {% set s_trim = s|trim %}
                {# Force these sizes to be available for testing and quick add UX #}
                {% set forced_sizes = ['L','XL','XXL'] %}
                {% set is_avail = (avail == sizes) or (s_trim in avail) or (s_trim in (product.size or '')) or (s_trim in forced_sizes) %}
              {# compute initial tabindex: first available gets 0 for keyboard tabbing, others -1; disabled remain -1 #}
              {% if is_avail and first_avail %}
                {% set tb = 0 %}
                {% set first_avail = false %}
              {% else %}
                {% set tb = -1 %}
              {% endif %}
              <button type="button"
                      class="size-btn text-sm border rounded py-2 px-2 flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-primary {% if not is_avail %}opacity-40 cursor-not-allowed{% endif %}"
                      role="radio"
                      aria-checked="false"
                      aria-label="Size {{ s_trim }}{% if not is_avail %}, unavailable{% else %}, available{% endif %}"
                      tabindex="{{ tb }}"
                      data-size="{{ s_trim }}"
                      {% if not is_avail %}aria-disabled="true" disabled{% endif %}>
                <span class="sr-only">Size </span>{{ s_trim }}
              </button>
            {% endfor %}
          </div>

          <div class="mt-3 flex items-center gap-3">
            <button id="quickAddBtn" class="ml-auto flex items-center gap-2 bg-green-600 text-white px-3 py-2 rounded disabled:opacity-50" title="Add selected size to cart" aria-disabled="true" disabled>
              <!-- cart icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2 5m5-5v5m4-5v5m4-5l2 5"/></svg>
              <span class="text-sm">Quick add</span>
            </button>
            <div id="cartStatus" class="sr-only" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex gap-3">
        <button id="selectSizeBtn" class="flex-1 bg-gray-900 text-white py-3 rounded hover:opacity-95 disabled:opacity-60" disabled>
          SELECT A SIZE
        </button>
        <button id="wishlistBtn" class="w-12 h-12 border rounded flex items-center justify-center" title="Add to wishlist">♡</button>
      </div>

      <div class="mt-4">
        <p class="text-sm text-gray-500">SKU: <span class="text-gray-700">{{ product.product_id }}</span></p>
      </div>
    </div>

  </div>
</section>

<script>
// Product detail interactivity: thumbnails, size selection, add-to-cart button enabling
(function(){
  const mainImg = document.getElementById('mainProductImage');
  const thumbs = Array.from(document.querySelectorAll('.thumbnail-btn'));
  const sizeBtns = Array.from(document.querySelectorAll('.size-btn'));
  const selectSizeBtn = document.getElementById('selectSizeBtn');
  const wishlistBtn = document.getElementById('wishlistBtn');
  const quickAddBtn = document.getElementById('quickAddBtn');
  const cartStatus = document.getElementById('cartStatus');
  const productMeta = document.getElementById('productMeta');
  const productId = productMeta ? Number(productMeta.dataset.productId || 0) : null;
  const productName = productMeta ? (productMeta.dataset.productName || '') : '';
  const productPrice = productMeta ? (Number(productMeta.dataset.productPrice) || 0) : 0;
  const productImage = productMeta ? (productMeta.dataset.productImage || '/static/images/dress.webp') : '/static/images/dress.webp';

  // Thumbnail click swaps main image
  thumbs.forEach(t => t.addEventListener('click', (e) => {
    const src = t.getAttribute('data-src');
    console.debug('thumbnail clicked ->', src);
    if (!src) return;
    mainImg.src = src;
  }));

  let selectedSize = null;
  function updateSizeUI(){
    sizeBtns.forEach(b => {
      if (b.disabled) {
        b.setAttribute('aria-checked', 'false');
        return;
      }
      const isSel = b.getAttribute('data-size') === selectedSize;
      if (isSel){
        b.classList.add('bg-gray-900','text-white');
        b.setAttribute('aria-checked','true');
        b.tabIndex = 0;
      } else {
        b.classList.remove('bg-gray-900','text-white');
        b.setAttribute('aria-checked','false');
        b.tabIndex = -1;
      }
    });
    if (selectedSize){
      if (selectSizeBtn) {
        selectSizeBtn.textContent = 'ADD TO CART';
        selectSizeBtn.disabled = false;
      }
      if (quickAddBtn) { quickAddBtn.disabled = false; quickAddBtn.removeAttribute('aria-disabled'); }
    } else {
      if (selectSizeBtn) {
        selectSizeBtn.textContent = 'SELECT A SIZE';
        selectSizeBtn.disabled = true;
      }
      if (quickAddBtn) { quickAddBtn.disabled = true; quickAddBtn.setAttribute('aria-disabled','true'); }
    }
  }

    // initialize size buttons (click + keyboard navigation) and unify add-to-cart behavior
  (function(){
    const sizeGroup = document.querySelector('[role="radiogroup"]');
    const sizeAnnouncer = document.getElementById('sizeAnnouncer');
    // refresh button list from the group (in case template changed)
    function getSizeButtons() { return Array.from(sizeGroup ? sizeGroup.querySelectorAll('.size-btn') : []); }

    function setInitialTabIndexes(){
      const buttons = getSizeButtons();
      let firstSet = false;
      buttons.forEach((b) => {
        if (b.disabled) {
          b.tabIndex = -1;
          b.setAttribute('aria-checked','false');
          return;
        }
        if (!firstSet) { b.tabIndex = 0; firstSet = true; } else { b.tabIndex = -1; }
        b.setAttribute('aria-checked','false');
      });
    }

    // announce selected size for screen readers
    function announceSize(text){
      try { if (sizeAnnouncer) sizeAnnouncer.textContent = text; } catch(e) {}
    }

    // delegate click inside the radiogroup
    if (sizeGroup) {
      sizeGroup.addEventListener('click', (e) => {
        const btn = e.target.closest && e.target.closest('.size-btn');
        if (!btn || btn.disabled) return;
        selectedSize = btn.getAttribute('data-size');
        console.debug('size clicked ->', selectedSize);
        updateSizeUI();
        btn.focus();
        announceSize('Selected size ' + selectedSize);
      });

      sizeGroup.addEventListener('keydown', (e) => {
        const key = e.key;
        const buttons = getSizeButtons();
        const activeIndex = buttons.findIndex(x => x === document.activeElement);
        let newIndex = activeIndex;

        if (key === 'ArrowRight' || key === 'ArrowDown'){
          e.preventDefault();
          for (let i = (activeIndex + 1) || 0; i < buttons.length; i++) { if (!buttons[i].disabled) { newIndex = i; break; } }
        } else if (key === 'ArrowLeft' || key === 'ArrowUp'){
          e.preventDefault();
          for (let i = (activeIndex - 1); i >= 0; i--) { if (!buttons[i].disabled) { newIndex = i; break; } }
        } else if (key === 'Enter' || key === ' '){
          e.preventDefault();
          const btn = document.activeElement.closest && document.activeElement.closest('.size-btn');
          if (btn && !btn.disabled) { btn.click(); }
        }

        if (newIndex !== activeIndex && buttons[newIndex]){
          buttons[newIndex].focus();
          selectedSize = buttons[newIndex].getAttribute('data-size');
          updateSizeUI();
          announceSize('Selected size ' + selectedSize);
        }
      });
    }

    // set initial tab indexes on load
    setInitialTabIndexes();

    // helper to update a small cart count badge in the navbar
    function updateCartBadge(cart) {
      try {
        const cartLink = document.querySelector('a[aria-label="Cart"]');
        if (!cartLink) return;
        let badge = cartLink.querySelector('.cart-count-badge');
        // response may be: { cart: [...] , total: ... } OR an array of items OR { items: [...] }
        let items = [];
        if (Array.isArray(cart)) items = cart;
        else if (cart && Array.isArray(cart.cart)) items = cart.cart;
        else if (cart && Array.isArray(cart.items)) items = cart.items;
        const count = items.length || 0;
        if (!badge) {
          badge = document.createElement('span');
          badge.className = 'cart-count-badge ml-1 inline-flex items-center justify-center bg-primary text-white rounded-full text-xs w-5 h-5';
          badge.setAttribute('aria-hidden','false');
          cartLink.appendChild(badge);
        }
        badge.textContent = count;
      } catch (e) { console.debug('updateCartBadge error', e); }
    }

    // shared add-to-cart action for selectSizeBtn and quickAddBtn (performs POST to server)
    function doAddToCart(btn) {
      if (!selectedSize) {
        console.debug('doAddToCart called but no size selected');
        if (window.showToast) window.showToast('Please select a size', 'error');
        return;
      }
      console.debug('doAddToCart ->', selectedSize, btn.id);
      const original = btn.innerHTML;
      btn.innerHTML = '<span class="loader inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>Adding...';
      btn.disabled = true;
      if (quickAddBtn && quickAddBtn !== btn) quickAddBtn.disabled = true;
      if (selectSizeBtn && selectSizeBtn !== btn) selectSizeBtn.disabled = true;
      if (cartStatus) cartStatus.textContent = `Adding size ${selectedSize} to cart`;

    const payload = { product_id: productId, quantity: 1, size: selectedSize };
      const headers = { 'Content-Type': 'application/json' };
      let token = null;
      try { token = localStorage.getItem('access_token'); } catch (e) { token = null; }
      if (token) headers['Authorization'] = 'Bearer ' + token;

  fetch('/cart/api/cart/add', { method: 'POST', headers: headers, body: JSON.stringify(payload) })
        .then(async (res) => {
          if (res.status === 401) {
            if (window.showToast) window.showToast('Please sign in to add items to cart', 'error');
            // restore UI and redirect to login
            if (cartStatus) cartStatus.textContent = '';
            try { btn.innerHTML = original; } catch (e) {}
            btn.disabled = false;
            if (quickAddBtn) quickAddBtn.disabled = false;
            if (selectSizeBtn) selectSizeBtn.disabled = false;
            setTimeout(() => { window.location = '/auth/login'; }, 700);
            return;
          }
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            const msg = data && data.error ? data.error : 'Failed to add to cart';
            if (window.showToast) window.showToast(msg, 'error');
            if (cartStatus) cartStatus.textContent = '';
            try { btn.innerHTML = original; } catch (e) {}
            btn.disabled = false;
            if (quickAddBtn) quickAddBtn.disabled = false;
            if (selectSizeBtn) selectSizeBtn.disabled = false;
            return;
          }

          // success: show toast and update navbar badge
          if (window.showToast) window.showToast('Added to cart', 'success');
          try { updateCartBadge(data); } catch (e) { console.debug('updateCartBadge failed', e); }

          // visual added state briefly
          try { btn.innerHTML = 'ADDED'; } catch (e) {}
          if (cartStatus) cartStatus.textContent = `Added size ${selectedSize} to cart`;
          setTimeout(() => {
            try { btn.innerHTML = original === '' ? 'ADD TO CART' : original; } catch (e) {}
            if (quickAddBtn) quickAddBtn.disabled = false;
            if (selectSizeBtn) selectSizeBtn.disabled = false;
            if (cartStatus) cartStatus.textContent = '';
          }, 1200);
        })
        .catch((err) => {
          console.error('add to cart error', err);
          if (window.showToast) window.showToast('Network error while adding to cart', 'error');
          if (cartStatus) cartStatus.textContent = '';
          try { btn.innerHTML = original; } catch (e) {}
          btn.disabled = false;
          if (quickAddBtn) quickAddBtn.disabled = false;
          if (selectSizeBtn) selectSizeBtn.disabled = false;
        });
    }

    if (selectSizeBtn) selectSizeBtn.addEventListener('click', (e) => { doAddToCart(selectSizeBtn); });
    if (quickAddBtn) quickAddBtn.addEventListener('click', (e) => { doAddToCart(quickAddBtn); });
    // ensure initial UI (disable quick add if no selection)
    updateSizeUI();
  })();

  // Wishlist button: store in localStorage and redirect to /wishlist
  (function(){
    if (!wishlistBtn) return;
    wishlistBtn.addEventListener('click', (e) => {
      e.preventDefault();
      try {
        const raw = localStorage.getItem('wishlist');
        const list = raw ? JSON.parse(raw) : [];
        // avoid duplicates by product_id
        const exists = list.find(i => Number(i.product_id) === Number(productId));
        if (!exists) {
          list.push({ product_id: productId, name: productName, price: productPrice, image: productImage });
          localStorage.setItem('wishlist', JSON.stringify(list));
          if (window.showToast) window.showToast('Added to wishlist', 'success');
        } else {
          if (window.showToast) window.showToast('Already in wishlist', 'info');
        }
      } catch (err) {
        console.error('wishlist add error', err);
        try { localStorage.setItem('wishlist', JSON.stringify([{ product_id: productId, name: productName, price: productPrice, image: productImage }])); } catch(e){}
      }
      // navigate to wishlist
      setTimeout(() => { window.location = '/wishlist'; }, 250);
    });
  })();
  })();
</script>

  {% endblock %}