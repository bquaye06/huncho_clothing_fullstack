{% extends 'base.html' %}
{% block title %}HunchØ.clothing | My Cart {% endblock %}
{% block content %}

<section class="max-w-6xl mx-auto px-6 py-12">
  <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">My Cart</h1>

  <div id="cartContainer" class="space-y-6">
    <p id="loading" class="text-center text-gray-500">Loading your cart...</p>
  </div>

  <div id="cartTotal" class="text-center mt-8 hidden">
    <p class="text-lg font-semibold text-gray-700">Total: <span id="totalPrice" class="text-primary text-2xl"></span></p>
    <button class="mt-4 bg-primary text-white px-6 py-3 rounded-lg hover:bg-red-600 transition">Proceed to Checkout</button>
  </div>
</section>

<script>
const token = localStorage.getItem("access_token");

async function loadCart() {
  if (!token) {
    document.getElementById("cartContainer").innerHTML = `
      <p class='text-center text-gray-500'>Please <a href='/auth/login' class='text-primary underline'>login</a> to view your cart.</p>`;
    return;
  }

  const res = await fetch("/cart/api/cart", {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();

  const container = document.getElementById("cartContainer");
  const totalDiv = document.getElementById("cartTotal");
  const totalPrice = document.getElementById("totalPrice");

  if (data.cart.length === 0) {
    container.innerHTML = `<p class='text-center text-gray-500'>Your cart is empty.</p>`;
    totalDiv.classList.add("hidden");
    return;
  }

  container.innerHTML = data.cart.map(item => `
    <div class="flex flex-col md:flex-row items-center justify-between border-b pb-4">
      <div class="flex items-center space-x-4 w-full md:w-2/3">
        <img src="${item.image || '/static/images/no-image.jpg'}" 
             alt="${item.name}" class="w-24 h-24 object-cover rounded-lg shadow">
        <div>
          <h3 class="font-semibold text-lg">${item.name}</h3>
          <p class="text-gray-500">₵${item.price.toFixed(2)}</p>
          <button onclick="removeItem(${item.cart_item_id})" 
                  class="text-sm text-red-500 hover:underline mt-1">Remove</button>
        </div>
      </div>
      <div class="mt-3 md:mt-0 flex items-center space-x-3">
        <button onclick="updateQuantity(${item.cart_item_id}, ${item.quantity - 1})" 
                class="px-3 py-1 bg-gray-200 rounded">-</button>
        <span>${item.quantity}</span>
        <button onclick="updateQuantity(${item.cart_item_id}, ${item.quantity + 1})" 
                class="px-3 py-1 bg-gray-200 rounded">+</button>
        <p class="ml-4 font-semibold">₵${item.subtotal.toFixed(2)}</p>
      </div>
    </div>
  `).join("");

  totalDiv.classList.remove("hidden");
  totalPrice.textContent = `₵${data.total.toFixed(2)}`;
}

async function updateQuantity(cart_item_id, newQty) {
  const res = await fetch("/cart/api/cart/update", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ cart_item_id, quantity: newQty })
  });
  await loadCart();
}

async function removeItem(cart_item_id) {
  const res = await fetch(`/cart/api/cart/remove/${cart_item_id}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  await loadCart();
}

document.addEventListener("DOMContentLoaded", loadCart);
</script>

{% endblock %}
