{% extends 'base.html' %}
{% block title %}HunchØ.clothing | Account Settings{% endblock %}
{% block content %}
<div class="max-w-6xl w-full mx-auto mt-12 px-6">
  <h3 class="text-sm tracking-wide text-gray-600 mb-6">ACCOUNT SETTINGS</h3>

  <!-- Tabs: Profile / Addresses / Orders -->
  <div class="mb-6">
    <nav id="accountTabs" class="inline-flex bg-white rounded-md shadow-sm relative" role="tablist" aria-label="Account tabs">
      <div id="tabIndicator" class="absolute bottom-0 left-0 h-0.5 bg-black rounded transition-all duration-300 ease-out" style="width:0; transform:translateX(0);"></div>
      <button id="tab-profile" class="px-6 py-3 text-sm font-medium text-black bg-white" role="tab" aria-selected="true">PROFILE</button>
      <!-- <button id="tab-addresses" class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-800" role="tab" aria-selected="false">ADDRESSES</button> -->
      <button id="tab-orders" class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-800" role="tab" aria-selected="false">ORDERS</button>
    </nav>
  </div>

  <div class="bg-white rounded-lg p-8 shadow-sm">
    <div id="profilePanel">
      <form id="accountForm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="first_name" class="block text-xs font-semibold text-gray-500 mb-2">FIRST NAME</label>
          <input id="first_name" name="first_name" type="text" class="w-full border border-gray-200 rounded-lg px-6 py-4 text-lg" />
        </div>

        <div>
          <label for="last_name" class="block text-xs font-semibold text-gray-500 mb-2">LAST NAME</label>
          <input id="last_name" name="last_name" type="text" class="w-full border border-gray-200 rounded-lg px-6 py-4 text-lg" />
        </div>

        <div class="md:col-span-2">
          <label for="email" class="block text-xs font-semibold text-gray-500 mb-2">EMAIL</label>
          <input id="email" name="email" type="email" disabled class="w-full border border-gray-200 rounded-lg px-6 py-4 text-lg bg-gray-50 text-gray-600" />
        </div>
      </div>

      <div class="mt-8 flex items-center justify-between">
        <div>
          <button id="saveBtn" type="submit" class="inline-flex items-center px-6 py-3 bg-black text-white rounded-md shadow hover:opacity-90">
            <svg id="saveSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <span id="saveText">SAVE PROFILE</span>
          </button>
        </div>

        <div>
          <button id="signOutBtn" type="button" class="inline-flex items-center px-6 py-3 bg-red-500 text-white rounded-md shadow hover:opacity-90">Sign Out</button>
        </div>
      </div>

      <p id="accountMsg" class="text-sm mt-4 hidden"></p>
      </form>
    </div>

    <div id="ordersPanel" class="hidden">
      <div id="ordersContainer" class="min-h-[40vh] p-6">
        <!-- Orders will be rendered here -->
      </div>
    </div>
  </div>
</div>

<script>
// helper: show desktop notification with toast fallback
function notifySuccess(title, body) {
  try {
    if ("Notification" in window) {
      if (Notification.permission === 'granted') {
        new Notification(title, { body: body, icon: '/static/images/logo_2.png' });
      } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(p => {
          if (p === 'granted') new Notification(title, { body: body, icon: '/static/images/logo_2.png' });
          else if (window.showToast) showToast(body, 'success');
        }).catch(() => { if (window.showToast) showToast(body, 'success'); });
      } else {
        // permission denied
        if (window.showToast) showToast(body, 'success');
      }
    } else {
      if (window.showToast) showToast(body, 'success');
    }
  } catch (e) {
    if (window.showToast) showToast(body, 'success');
  }
}

// Ensure we have Notification permission. Returns a promise resolving to the permission string.
function ensureNotificationPermission() {
  return new Promise((resolve) => {
    try {
      if (!('Notification' in window)) {
        console.log('Notifications API not supported');
        return resolve('unsupported');
      }
      // If already granted/denied, return immediately
      if (Notification.permission === 'granted' || Notification.permission === 'denied') {
        console.log('Notification permission state:', Notification.permission);
        return resolve(Notification.permission);
      }
      // Request permission in response to a user gesture (click). This should be allowed.
      Notification.requestPermission().then(p => {
        console.log('Notification permission result:', p);
        resolve(p);
      }).catch(err => {
        console.warn('Notification permission request failed', err);
        resolve('error');
      });
    } catch (e) {
      console.warn('ensureNotificationPermission error', e);
      resolve('error');
    }
  });
}

async function loadProfile() {
  const token = localStorage.getItem('access_token');
  if (!token) {
    window.location.href = '/auth/login';
    return;
  }

  try {
    // be defensive: allow stored token to already include 'Bearer ' and strip stray quotes
    let raw = token || '';
    raw = raw.replace(/^"|"$/g, '');
    const authHeader = raw.startsWith('Bearer ') ? raw : ('Bearer ' + raw);

const res = await fetch('/account/user/profile', {
    method: 'GET',
    headers: {
      'Authorization': authHeader,
      'Accept': 'application/json'
    }
  });

  if (res.ok) {
    const data = await res.json();
    // fill only the fields we have on the form
    if (data.first_name && document.getElementById('first_name'))
      document.getElementById('first_name').value = data.first_name;
    if (data.last_name && document.getElementById('last_name'))
      document.getElementById('last_name').value = data.last_name;
    if (data.email && document.getElementById('email'))
      document.getElementById('email').value = data.email;
  } else {
    // read text for better debug (some errors aren't JSON)
    const txt = await res.text();
    console.error('Profile fetch failed', res.status, txt);
    let parsed = {};
    try {
      parsed = JSON.parse(txt);
    } catch (e) {
      /* not JSON */
    }
    const displayMsg =
      parsed.error ||
      parsed.message ||
      `Failed to load profile. (status ${res.status})`;

    const msgEl = document.getElementById('accountMsg');
    msgEl.innerHTML = '';

    const spanEl = document.createElement('span');
    spanEl.textContent = displayMsg + ' ';

    const action = document.createElement('a');
    action.href = '/auth/login';
    action.textContent = 'Sign in';
    action.className = 'ml-2 underline text-sm text-primary';

    msgEl.appendChild(spanEl);
    msgEl.appendChild(action);
    msgEl.className = 'text-red-600';

    if (window.showToast)
      showToast(displayMsg, 'error', { duration: 6000 });
  }
} catch (err) {
  console.error('Profile load error', err);
  document.getElementById('accountMsg').textContent = 'Failed to load profile.';
  document.getElementById('accountMsg').className = 'text-red-600';
}
}

document.getElementById('accountForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('accountMsg');
  msg.textContent = '';
  const token = localStorage.getItem('access_token');
  if (!token) { window.location.href = '/auth/login'; return; }

  const payload = {
    first_name: document.getElementById('first_name').value,
    last_name: document.getElementById('last_name').value
  };

  const saveBtn = document.getElementById('saveBtn');
  const saveSpinner = document.getElementById('saveSpinner');
  const saveText = document.getElementById('saveText');

  try {
    // Request notification permission now (this is a user gesture from the click)
    const perm = await ensureNotificationPermission();
    if (perm === 'denied') {
      // show toast that notifications are blocked and instruct how to enable
      if (window.showToast) showToast('Desktop notifications are blocked. You can enable them in your browser settings.', 'info', {duration: 6000});
    }
    // show loader
    saveBtn.setAttribute('disabled', 'disabled');
    saveSpinner.classList.remove('hidden');
    saveText.classList.add('opacity-75');

    // defensive auth header (handle token that already contains Bearer or stray quotes)
    let raw = token || '';
    raw = raw.replace(/^"|"$/g, '');
    const authHeader = raw.startsWith('Bearer ') ? raw : ('Bearer ' + raw);

    const res = await fetch('/account/user/update', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authHeader,
        'Accept': 'application/json'
      },
      body: JSON.stringify(payload)
    });

    const txt = await res.text();
    let result = {};
    try { result = JSON.parse(txt); } catch (e) { result = { error: txt }; }
    console.log('Update profile response', res.status, result);
    msg.textContent = result.message || result.error || '';
    msg.className = res.ok ? 'text-green-600' : 'text-red-600';
    // show desktop notification on success; fallback to toast already provided in helper
    if (res.ok) {
      const title = 'Profile saved';
      const body = result.message || 'Your profile was updated successfully.';
      notifySuccess(title, body);
    }
    if (!res.ok && (res.status === 422 || res.status === 401 || res.status === 403)) {
      // likely an auth issue — inform the user and offer a sign-in action instead of auto-logout
      const display = result.error || result.message || ('Authentication issue (status ' + res.status + ')');
      if (window.showToast) showToast(display, 'error', {duration: 6000});
      // make a small inline action so the user can sign back in when ready
      try {
        const a = document.createElement('a');
        a.href = '/auth/login';
        a.textContent = ' Sign in';
        a.className = 'ml-2 underline text-sm text-primary';
        msg.appendChild(a);
      } catch(e) { /* ignore DOM errors */ }
    }
  } catch (err) {
    msg.textContent = 'Something went wrong.';
    msg.className = 'text-red-600';
  } finally {
    // hide loader
    saveSpinner.classList.add('hidden');
    saveText.classList.remove('opacity-75');
    saveBtn.removeAttribute('disabled');
  }
});

document.getElementById('signOutBtn').addEventListener('click', () => {
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
  window.location.href = '/';
});

// Animated tab indicator helper
function moveIndicatorTo(el){
  try{
    const ind = document.getElementById('tabIndicator');
    const nav = document.getElementById('accountTabs');
    if (!ind || !nav || !el) return;
    const elRect = el.getBoundingClientRect();
    const navRect = nav.getBoundingClientRect();
    const left = elRect.left - navRect.left;
    ind.style.width = elRect.width + 'px';
    ind.style.transform = `translateX(${left}px)`;
  }catch(e){/* ignore */}
}

// Tab switching logic
function showPanel(panelId){
  document.getElementById('profilePanel').classList.toggle('hidden', panelId !== 'profile');
  document.getElementById('ordersPanel').classList.toggle('hidden', panelId !== 'orders');
  // update aria-selected states
  document.getElementById('tab-profile').setAttribute('aria-selected', panelId === 'profile');
  document.getElementById('tab-orders').setAttribute('aria-selected', panelId === 'orders');
  // move indicator
  const btn = panelId === 'profile' ? document.getElementById('tab-profile') : document.getElementById('tab-orders');
  moveIndicatorTo(btn);
}

document.getElementById('tab-profile').addEventListener('click', (e) => { showPanel('profile'); });
document.getElementById('tab-orders').addEventListener('click', (e) => { showPanel('orders'); loadOrders(); });

async function loadOrders(){
  const container = document.getElementById('ordersContainer');
  container.innerHTML = '<div class="text-center text-gray-500 p-12">Loading orders...</div>';
  const token = localStorage.getItem('access_token');
  if (!token) { container.innerHTML = '<div class="text-center p-12">Please <a href="/auth/login" class="text-primary underline">sign in</a> to view orders.</div>'; return; }
  let raw = token.replace(/^\"|\"$/g, '');
  const auth = raw.startsWith('Bearer ') ? raw : ('Bearer ' + raw);
  try{
    const res = await fetch('/account/orders', { headers: { 'Authorization': auth, 'Accept': 'application/json' } });
    if (!res.ok){
      if (res.status === 401){ container.innerHTML = '<div class="text-center p-12">Please <a href="/auth/login" class="text-primary underline">sign in</a> to view orders.</div>'; return; }
      container.innerHTML = '<div class="text-center p-12 text-red-500">Unable to load orders.</div>'; return;
    }
    const json = await res.json();
    const orders = json.orders || [];
    if (!orders.length){
      container.innerHTML = '<div class="text-center py-16"><h3 class="text-lg font-semibold">No orders yet</h3><p class="text-sm text-gray-500 mt-2">You haven\'t placed any orders yet. Start shopping to see your order history.</p><div class="mt-6"><a href="/shop" class="inline-block bg-black text-white py-2 px-4 rounded shadow">Start Shopping</a></div></div>';
      return;
    }

    // render orders list
    const html = orders.map(o => {
      const dt = new Date(o.created_at).toLocaleString();
      const total = o.total_amount ? ('₵' + Number(o.total_amount).toFixed(2)) : '';
      const status = o.status || 'pending';
      const itemsHtml = (o.items || []).map(it => `
          <div class="flex items-center gap-4 py-3 border-b">
            <img src="${it.image || '/static/images/dress.webp'}" class="w-20 h-20 object-contain" alt="${(it.product_name||'').replace(/\"/g,'')}">
            <div class="flex-1">
              <div class="text-sm font-medium">${it.product_name || 'Product'}</div>
              <div class="text-xs text-gray-500">Qty: ${it.quantity} — ₵${Number(it.price).toFixed(2)}</div>
            </div>
          </div>
        `).join('');
  
        return `
          <div class="mb-8">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm text-gray-500">Order #${o.order_id} • ${dt}</div>
              <div class="text-sm font-semibold">${total} <span class="ml-4 text-xs text-gray-500">${status.toUpperCase()}</span></div>
            </div>
            <div class="bg-gray-50 p-4 rounded">${itemsHtml}</div>
          </div>
        `;
    }).join('');

    container.innerHTML = `<div>${html}</div>`;
  }catch(err){ console.error('loadOrders', err); container.innerHTML = '<div class="text-center p-12 text-red-500">Failed to load orders.</div>'; }
}

document.addEventListener('DOMContentLoaded', loadProfile);
// initialize indicator after profile load; allow small timeout to ensure layout
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(()=>{
    const active = document.querySelector('#accountTabs [aria-selected="true"]') || document.getElementById('tab-profile');
    moveIndicatorTo(active);
  }, 30);
});

window.addEventListener('resize', ()=>{
  const active = document.querySelector('#accountTabs [aria-selected="true"]');
  moveIndicatorTo(active);
});
</script>

{% endblock %}
