{% extends 'base.html' %}
{% block title %}Verify OTP | Hunch√ò.clothing{% endblock %}

{% block content %}

<!-- Modern verify OTP split layout -->
<div class="w-full max-w-6xl bg-transparent rounded-lg p-4">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-stretch">

    <!-- Left visual promo -->
  <div class="hidden lg:flex rounded-lg overflow-hidden bg-cover bg-center" style="background: linear-gradient(135deg, rgba(225,29,72,0.85), rgba(15,23,42,0.85)), url('{{ url_for('static', filename='images/logo_2.png') }}'); background-size: cover; background-position: center;">
      <div class="p-12 text-white flex flex-col justify-center gap-4">
        <h1 class="text-4xl font-extrabold leading-tight">Verify account</h1>
        <p class="opacity-90 max-w-md">Enter the OTP sent to your email or phone to complete registration and start shopping.</p>
        <a href="/shop" class="mt-4 inline-block bg-white text-dark px-4 py-2 rounded font-medium hover:opacity-90">Shop now</a>
      </div>
    </div>

    <!-- Right: verify card -->
    <div class="bg-white rounded-lg shadow-md p-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-dark">Verify your account</h2>
          <p class="text-sm text-gray-500">Enter the 4-6 digit code sent to your email or phone.</p>
        </div>
  <img src="{{ url_for('static', filename='images/logo_2.png') }}" alt="logo" class="h-10 w-auto">
      </div>

      <form id="otpForm" class="space-y-4">
        <div class="text-center">
          <p class="text-sm text-gray-500 mb-4">Your code was sent to you via email</p>
        </div>

        <div class="flex items-center justify-center gap-3 mb-2">
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
          <input inputmode="numeric" pattern="[0-9]*" maxlength="1" class="otp-input w-12 h-12 text-center rounded-md border border-gray-200 bg-white text-xl font-medium focus:outline-none focus:ring-2 focus:ring-primary" />
        </div>

        <div class="flex items-center justify-between text-sm">
          <a href="/auth/register" class="text-primary hover:underline">Back to signup</a>
          <a href="#" id="resend-otp-link" class="text-gray-500 hover:underline">Resend OTP</a>
        </div>

        <button type="submit" class="w-full bg-primary text-white py-3 rounded-md hover:opacity-95 transition">Verify</button>
        <p id="message" class="text-center mt-2 text-sm"></p>
      </form>
    </div>

  </div>
</div>

<script>
// Prefill email from query string if available, otherwise fallback to localStorage (used for resend)
const params = new URLSearchParams(window.location.search);
let preEmail = params.get('email');
if(!preEmail){
  try{
    const stored = localStorage.getItem('prefill_email');
    if(stored) preEmail = stored;
  }catch(e){ /* ignore */ }
}

// OTP input handling (6 boxes)
const otpInputs = Array.from(document.querySelectorAll('.otp-input'));
otpInputs.forEach((input, idx) => {
  input.addEventListener('input', (e) => {
    const val = e.target.value.replace(/[^0-9]/g, '');
    e.target.value = val;
    if (val && idx < otpInputs.length - 1) otpInputs[idx+1].focus();
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && !e.target.value && idx > 0) {
      otpInputs[idx-1].focus();
    }
    if (e.key === 'ArrowLeft' && idx > 0) otpInputs[idx-1].focus();
    if (e.key === 'ArrowRight' && idx < otpInputs.length -1) otpInputs[idx+1].focus();
  });
  input.addEventListener('paste', (e) => {
    e.preventDefault();
    const paste = (e.clipboardData || window.clipboardData).getData('text') || '';
    const digits = paste.replace(/\D/g, '').slice(0, otpInputs.length).split('');
    digits.forEach((d, i) => {
      otpInputs[i].value = d;
    });
    const next = Math.min(digits.length, otpInputs.length-1);
    otpInputs[next].focus();
  });
});

document.getElementById('otpForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('message');
  const otp = otpInputs.map(i => i.value || '').join('');
  if (otp.length < otpInputs.length) {
    if (window.showToast) showToast('Please enter the full code', 'error');
    return;
  }
  if (window.showToast) showToast('Verifying...', 'info', {duration:2000});

  try {
    const params = new URLSearchParams(window.location.search);
    const flow = params.get('flow');
    const endpoint = (flow === 'login') ? '/auth/verify-login' : '/auth/verify-otp';

    const res = await fetch(endpoint, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ otp })
    });
    const result = await res.json().catch(()=>({}));
    if (window.showToast) showToast(result.message || result.error || '', res.ok ? 'success' : 'error');

    if (res.status === 200) {
      if (flow === 'login') {
        // store tokens and redirect
        try {
          if (result.access_token) localStorage.setItem('access_token', result.access_token);
          if (result.refresh_token) localStorage.setItem('refresh_token', result.refresh_token);
        } catch(e){}
        try {
          if (result.is_admin) { try { localStorage.setItem('admin_token', result.access_token); } catch(e){} window.location.href = '/admin/dashboard'; return; }
        } catch(e){}
        setTimeout(()=> window.location.href = '/', 700);
      } else {
        setTimeout(()=> window.location.href = '/auth/login', 800);
      }
    }
  } catch (err) {
    console.debug('verify-otp submit error', err);
    if (window.showToast) showToast('Something went wrong. Please try again.', 'error');
  }
});

// Resend OTP via AJAX without leaving the page
const resendLink = document.getElementById('resend-otp-link');
if (resendLink) {
  resendLink.addEventListener('click', async (ev) => {
    ev.preventDefault();
    // prevent double clicks
    if (resendLink.dataset.locked === '1') return;

    // Use previously-detected preEmail or prompt the user for email
    let emailVal = preEmail || '';
    if (!emailVal) {
      emailVal = window.prompt('Please enter your email to resend the OTP:') || '';
    }
    emailVal = emailVal.trim();
    if (!emailVal) {
      if (window.showToast) showToast('Email is required to resend the OTP.', 'error');
      return;
    }

    try {
      resendLink.dataset.locked = '1';
      resendLink.classList.add('opacity-50');
      if (window.showToast) showToast('Resending OTP...', 'info');

      const res = await fetch('/auth/resend-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: emailVal })
      });

      const payload = await res.json().catch(() => ({}));
      if (res.ok) {
        if (window.showToast) showToast(payload.message || 'OTP resent. Check your email or phone.', 'success');
      } else {
        const err = payload.error || payload.message || 'Failed to resend OTP.';
        if (window.showToast) showToast(err, 'error');
      }

    } catch (err) {
      if (window.showToast) showToast('Network error while resending OTP. Try again.', 'error');
    } finally {
      resendLink.dataset.locked = '0';
      resendLink.classList.remove('opacity-50');
    }
  });
}
</script>

{% endblock %}
