{% extends 'admin/base.html' %}
{% block title %}Products | Admin{% endblock %}
{% block content %}

<section class="max-w-7xl mx-auto px-6 py-12">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Products</h1>
      <p class="text-sm text-gray-500">Manage your catalogue — add, edit, delete and export products.</p>
    </div>

    <div class="flex items-center gap-3">
      <div class="relative">
        <input id="productSearch" type="search" placeholder="Search products by name or brand" class="w-64 pl-10 pr-4 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary" />
        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z"/></svg>
      </div>
      <button id="exportCsv" class="border px-4 py-2 rounded-lg text-sm text-gray-700 hover:bg-gray-50">Export CSV</button>
      <button id="addProductBtn" onclick="openAddModal()" class="inline-flex items-center gap-2 bg-gradient-to-r from-emerald-500 to-green-600 text-white px-5 py-3 rounded-lg shadow-lg hover:from-emerald-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-emerald-300 transform hover:-translate-y-0.5 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/></svg>
        <span class="font-medium">Add Product</span>
      </button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="bg-white rounded-xl shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-600">Product</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-600">Price</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-600">Stock</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-600">Brand</th>
            <th class="px-6 py-3 text-left text-sm font-medium text-gray-600">Created</th>
            <th class="px-6 py-3 text-center text-sm font-medium text-gray-600">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTable" class="bg-white divide-y divide-gray-100">
          {% for p in products %}
          <tr class="hover:bg-gray-50" data-id="{{ p.product_id }}">
            <td class="px-6 py-4 flex items-center gap-4">
              <img src="{{ p.image_url or url_for('static', filename='images/no-image.jpg') }}" alt="{{ p.name }}" class="w-16 h-16 rounded-md object-cover">
              <div>
                <div class="text-sm font-medium text-gray-900">{{ p.name }}</div>
                <div class="text-xs text-gray-500">{{ p.size or '-' }} · {{ p.color or '-' }}</div>
              </div>
            </td>
            <td class="px-6 py-4">₵{{ '%.2f'|format(p.price or 0) }}</td>
            <td class="px-6 py-4">{{ p.stock or 0 }}</td>
            <td class="px-6 py-4">{{ p.brand or '-' }}</td>
            <td class="px-6 py-4 text-sm text-gray-500">{{ p.created_at.strftime('%Y-%m-%d') if p.created_at else '-' }}</td>
            <td class="px-6 py-4 text-center">
              <div class="inline-flex items-center gap-3">
                <button class="editBtn p-2 rounded-md hover:bg-gray-100" title="Edit" data-id="{{ p.product_id }}">
                  <svg class="w-5 h-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h6M5 7v10a2 2 0 0 0 2 2h10M17 3l4 4M3 21h18"/></svg>
                </button>
                <button class="deleteBtn p-2 rounded-md hover:bg-gray-100" title="Delete" data-id="{{ p.product_id }}">
                  <svg class="w-5 h-5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7L5 7M10 11v6M14 11v6M6 7l1 12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-12"/></svg>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- Add/Edit Modal -->
<div id="productModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-0 overflow-y-auto max-h-[90vh]">
    <div class="flex items-center justify-between px-5 py-4 border-b">
      <div class="flex items-center gap-3">
        <h2 id="modalTitle" class="text-lg font-semibold">Add Product</h2>
        <span id="modalModeBadge" class="text-xs text-gray-500">New</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="modalDeleteBtn" class="hidden text-sm px-3 py-1 rounded bg-red-50 text-red-700 hover:bg-red-100">Delete</button>
        <button id="modalCloseBtn" aria-label="Close modal" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
    </div>

    <form id="productForm" class="space-y-4 p-5" enctype="multipart/form-data" novalidate>
      <input type="hidden" id="productId">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700">Name <span class="text-red-500">*</span></label>
          <input type="text" name="name" id="name" placeholder="Product Name" required class="mt-1 block w-full p-3 border rounded-lg focus:ring-2 focus:ring-emerald-200" />
          <p id="err-name" class="text-xs text-red-600 mt-1 hidden"></p>
        </div>

        <div>
          <label for="price" class="block text-sm font-medium text-gray-700">Price (GHS) <span class="text-red-500">*</span></label>
          <input type="number" step="0.01" name="price" id="price" placeholder="0.00" required class="mt-1 block w-full p-3 border rounded-lg focus:ring-2 focus:ring-emerald-200" />
          <p id="err-price" class="text-xs text-red-600 mt-1 hidden"></p>
        </div>

        <div>
          <label for="stock" class="block text-sm font-medium text-gray-700">Stock</label>
          <input type="number" name="stock" id="stock" placeholder="0" class="mt-1 block w-full p-3 border rounded-lg" />
        </div>

        <div>
          <label for="brand" class="block text-sm font-medium text-gray-700">Brand</label>
          <input type="text" name="brand" id="brand" placeholder="Brand" class="mt-1 block w-full p-3 border rounded-lg" />
        </div>

        <div>
          <label for="size" class="block text-sm font-medium text-gray-700">Size</label>
          <input type="text" name="size" id="size" placeholder="e.g. M, L" class="mt-1 block w-full p-3 border rounded-lg" />
        </div>

        <div>
          <label for="color" class="block text-sm font-medium text-gray-700">Color</label>
          <input type="text" name="color" id="color" placeholder="Color" class="mt-1 block w-full p-3 border rounded-lg" />
        </div>
      </div>

      <div>
        <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
        <textarea name="description" id="description" placeholder="Short product description" class="mt-1 block w-full p-3 border rounded-lg" rows="4"></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Image</label>
        <div id="imageDrop" class="mt-2 border-2 border-dashed border-gray-200 rounded-lg p-4 text-center cursor-pointer bg-gray-50">
          <svg class="mx-auto h-8 w-8 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7l6 6m0 0l6-6M9 13v8"/></svg>
          <p class="mt-2 text-sm text-gray-600">Drag & drop an image here, or click to select a file</p>
          <input type="file" name="image" id="image" class="hidden" accept="image/*">
          <div id="imagePreviewWrap" class="mt-3 flex items-start gap-3">
            <img id="imagePreview" src="" alt="Preview" class="w-28 h-28 object-cover rounded-md hidden">
            <div>
              <button id="removeImageBtn" type="button" class="hidden text-sm px-3 py-1 border rounded">Remove</button>
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between pt-4 border-t">
        <div class="text-sm text-gray-500">Changes are saved to your database.</div>
        <div class="flex items-center gap-3">
          <button type="button" onclick="closeModal()" class="px-4 py-2 rounded border">Cancel</button>
          <button id="modalSaveBtn" type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded bg-primary text-white">
            <svg id="saveSpinner" class="w-4 h-4 animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v4m0 8v4m8-8h-4M4 12H0"/></svg>
            <span id="saveText">Save</span>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Toast container -->
<div id="toastContainer" class="fixed top-6 right-6 z-50 space-y-2"></div>

<!-- Spinner overlay -->
<div id="productsSpinner" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-40">
  <div class="bg-white p-6 rounded-lg shadow flex items-center gap-3">
    <svg class="w-6 h-6 animate-spin text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v4m0 8v4m8-8h-4M4 12H0"/></svg>
    <div class="text-sm">Working…</div>
  </div>
</div>

<script>
const token = localStorage.getItem('admin_token');

function apiFetch(url, opts = {}) {
  opts.credentials = 'same-origin';
  opts.headers = opts.headers || {};
  if (!opts.headers['Accept']) opts.headers['Accept'] = 'application/json';
  const t = localStorage.getItem('admin_token');
  if (t) opts.headers['Authorization'] = 'Bearer ' + t;
  return fetch(url, opts);
}

function showToast(message, type = 'info', timeout = 4000) {
  const c = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = 'px-4 py-2 rounded shadow-lg text-sm flex items-center gap-3 ' + (type === 'success' ? 'bg-emerald-50 text-emerald-800' : type === 'error' ? 'bg-red-50 text-red-800' : 'bg-white text-gray-800');
  el.innerText = message;
  c.appendChild(el);
  setTimeout(() => { el.remove(); }, timeout);
}

function showSpinner(show = true) {
  const s = document.getElementById('productsSpinner');
  if (show) {
    s.classList.remove('hidden'); s.classList.add('flex');
  } else {
    s.classList.add('hidden'); s.classList.remove('flex');
  }
}

function openAddModal() {
  document.getElementById('modalTitle').innerText = 'Add Product';
  document.getElementById('productForm').reset();
  document.getElementById('productId').value = '';
  document.getElementById('imagePreview').classList.add('hidden');
  document.getElementById('productModal').classList.remove('hidden');
  document.getElementById('productModal').classList.add('flex');
}

function closeModal() {
  document.getElementById('productModal').classList.add('hidden');
  document.getElementById('productModal').classList.remove('flex');
}

// Build a safe PRODUCTS array on the client for editing
const PRODUCTS = [
  {% for p in products %}
  {
    product_id: {{ p.product_id }},
    name: {{ p.name|tojson }},
    price: {{ p.price or 0 }},
    stock: {{ p.stock or 0 }},
    brand: {{ p.brand|tojson }},
    size: {{ p.size|tojson }},
    color: {{ p.color|tojson }},
    description: {{ p.description|tojson }},
    image_url: {{ p.image_url|tojson }},
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

function populateFormFromProduct(id) {
  const p = PRODUCTS.find(x => x.product_id == id);
  if (!p) return;
  document.getElementById('modalTitle').innerText = 'Edit Product';
  document.getElementById('productId').value = p.product_id;
  document.getElementById('name').value = p.name || '';
  document.getElementById('price').value = p.price || '';
  document.getElementById('stock').value = p.stock || '';
  document.getElementById('brand').value = p.brand || '';
  document.getElementById('size').value = p.size || '';
  document.getElementById('color').value = p.color || '';
  document.getElementById('description').value = p.description || '';
  if (p.image_url) {
    const img = document.getElementById('imagePreview');
    img.src = p.image_url; img.classList.remove('hidden');
  }
  document.getElementById('productModal').classList.remove('hidden');
  document.getElementById('productModal').classList.add('flex');
}

document.addEventListener('click', e => {
  if (e.target.closest('.editBtn')) {
    const id = e.target.closest('.editBtn').dataset.id;
    populateFormFromProduct(id);
  }
  if (e.target.closest('.deleteBtn')) {
    const id = e.target.closest('.deleteBtn').dataset.id;
    deleteProduct(id);
  }
});

document.getElementById('image').addEventListener('change', function () {
  const f = this.files && this.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const img = document.getElementById('imagePreview');
  img.src = url; img.classList.remove('hidden');
});

// Modal controls: close, delete (in-modal), focus management, drag-drop
const modal = document.getElementById('productModal');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalDeleteBtn = document.getElementById('modalDeleteBtn');
const imageDrop = document.getElementById('imageDrop');
const imageInput = document.getElementById('image');
const removeImageBtn = document.getElementById('removeImageBtn');
const saveBtn = document.getElementById('modalSaveBtn');
const saveSpinner = document.getElementById('saveSpinner');
let lastActiveElement = null;

modalCloseBtn.addEventListener('click', () => closeModal());
modal.addEventListener('keydown', (ev) => {
  if (ev.key === 'Escape') closeModal();
});

function openModalUI() {
  lastActiveElement = document.activeElement;
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  // focus first input
  const first = modal.querySelector('input, textarea, button');
  if (first) first.focus();
}

function closeModalUI() {
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  if (lastActiveElement && typeof lastActiveElement.focus === 'function') lastActiveElement.focus();
}

function openAddModal() {
  document.getElementById('modalTitle').innerText = 'Add Product';
  document.getElementById('modalModeBadge').innerText = 'New';
  document.getElementById('productForm').reset();
  document.getElementById('productId').value = '';
  document.getElementById('imagePreview').classList.add('hidden');
  modalDeleteBtn.classList.add('hidden');
  openModalUI();
}

function populateFormFromProduct(id) {
  const p = PRODUCTS.find(x => x.product_id == id);
  if (!p) return;
  document.getElementById('modalTitle').innerText = 'Edit Product';
  document.getElementById('modalModeBadge').innerText = 'Edit';
  document.getElementById('productId').value = p.product_id;
  document.getElementById('name').value = p.name || '';
  document.getElementById('price').value = p.price || '';
  document.getElementById('stock').value = p.stock || '';
  document.getElementById('brand').value = p.brand || '';
  document.getElementById('size').value = p.size || '';
  document.getElementById('color').value = p.color || '';
  document.getElementById('description').value = p.description || '';
  if (p.image_url) {
    const img = document.getElementById('imagePreview');
    img.src = p.image_url; img.classList.remove('hidden');
    removeImageBtn.classList.remove('hidden');
  } else {
    document.getElementById('imagePreview').classList.add('hidden');
    removeImageBtn.classList.add('hidden');
  }
  modalDeleteBtn.classList.remove('hidden');
  openModalUI();
}

// drag & drop handlers for image
['dragenter','dragover'].forEach(ev => imageDrop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); imageDrop.classList.add('ring-2','ring-emerald-200'); }));
['dragleave','drop','dragend'].forEach(ev => imageDrop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); imageDrop.classList.remove('ring-2','ring-emerald-200'); }));
imageDrop.addEventListener('click', () => imageInput.click());
imageDrop.addEventListener('drop', (e) => {
  const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (!f) return;
  const dt = new DataTransfer(); dt.items.add(f); imageInput.files = dt.files;
  const url = URL.createObjectURL(f);
  const img = document.getElementById('imagePreview'); img.src = url; img.classList.remove('hidden'); removeImageBtn.classList.remove('hidden');
});

removeImageBtn.addEventListener('click', () => {
  document.getElementById('imagePreview').src = '';
  document.getElementById('imagePreview').classList.add('hidden');
  imageInput.value = '';
  removeImageBtn.classList.add('hidden');
});

modalDeleteBtn.addEventListener('click', async () => {
  const id = document.getElementById('productId').value;
  if (!id) return;
  const ok = await showConfirm('Delete product', 'This will remove the product permanently. Proceed?');
  if (!ok) return;
  await deleteProduct(id);
  closeModalUI();
});

function closeModal() { closeModalUI(); }

document.getElementById('productForm').addEventListener('submit', async e => {
  e.preventDefault();
  showSpinner(true);
  saveBtn.disabled = true; saveSpinner.classList.remove('hidden');
  try {
    const formData = new FormData(document.getElementById('productForm'));
    const id = document.getElementById('productId').value;
    const res = await apiFetch(id ? `/admin/api/products/${id}` : '/admin/api/products', {
      method: id ? 'PUT' : 'POST',
      body: formData
    });
    if (res.ok) {
      showToast('Product saved', 'success');
      closeModal();
      setTimeout(() => location.reload(), 600);
    } else {
      const txt = await res.text();
      showToast('Failed to save product: ' + txt, 'error');
    }
  } catch (err) {
    showToast('Error saving product: ' + err.message, 'error');
  } finally {
    showSpinner(false);
    saveBtn.disabled = false; saveSpinner.classList.add('hidden');
  }
});

async function deleteProduct(id) {
  const ok = await showConfirm('Delete product', 'Are you sure you want to delete this product? This action cannot be undone.');
  if (!ok) return;
  showSpinner(true);
  try {
    const res = await apiFetch(`/admin/api/products/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast('Product deleted', 'success');
      setTimeout(() => location.reload(), 400);
    } else {
      const txt = await res.text();
      showToast('Failed to delete: ' + txt, 'error');
    }
  } catch (err) {
    showToast('Error: ' + err.message, 'error');
  } finally {
    showSpinner(false);
  }
}

// Simple promise-based confirm modal (reusable)
function showConfirm(title, message) {
  return new Promise(resolve => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-60';
    modal.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-semibold mb-2">${title}</h3>
        <p class="text-sm text-gray-600 mb-4">${message}</p>
        <div class="flex justify-end gap-3">
          <button id="_c_cancel" class="px-4 py-2 border rounded">Cancel</button>
          <button id="_c_ok" class="px-4 py-2 bg-red-600 text-white rounded">Delete</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    modal.querySelector('#_c_cancel').addEventListener('click', () => { modal.remove(); resolve(false); });
    modal.querySelector('#_c_ok').addEventListener('click', () => { modal.remove(); resolve(true); });
  });
}

// Simple client-side search/filter
document.getElementById('productSearch').addEventListener('input', function () {
  const q = this.value.toLowerCase().trim();
  document.querySelectorAll('#productsTable tr').forEach(row => {
    const txt = row.innerText.toLowerCase();
    row.style.display = txt.indexOf(q) > -1 ? '' : 'none';
  });
});

// Export CSV
document.getElementById('exportCsv').addEventListener('click', function () {
  const rows = [['product_id','name','price','stock','brand','size','color']];
  PRODUCTS.forEach(p => rows.push([p.product_id, p.name, p.price, p.stock, p.brand, p.size, p.color]));
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'products.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
</script>

{% endblock %}
