{% extends 'admin/base.html' %}
{% block title %}Orders | Admin{% endblock %}
{% block content %}

<section class="max-w-7xl mx-auto px-6 py-12">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Orders</h1>
      <p class="text-sm text-gray-500 mt-1">Manage customer orders — search, filter, export and view details.</p>
    </div>

    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="relative w-full md:w-64">
        <svg class="absolute left-3 top-3 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
        <input id="ordersSearch" type="search" placeholder="Search orders, customer, email or product" class="pl-10 pr-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary" />
      </div>

      <select id="statusFilter" class="py-2 px-3 border rounded-lg bg-white focus:outline-none">
        <option value="">All statuses</option>
        <option value="Pending">Pending</option>
        <option value="Processing">Processing</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>

      <button id="exportCsv" class="hidden md:inline-flex items-center gap-2 bg-gray-800 text-white px-3 py-2 rounded-lg hover:opacity-95">
        Export CSV
      </button>
    </div>
  </div>

  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <div class="px-4 py-3 flex items-center justify-between border-b">
      <div class="text-sm text-gray-600">Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span> orders</div>
      <div class="flex items-center gap-2">
        <label class="text-sm text-gray-500">Rows</label>
        <select id="pageSize" class="py-1 px-2 border rounded">
          <option>10</option>
          <option>25</option>
          <option>50</option>
        </select>
      </div>
    </div>

    <table id="ordersTable" class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Order ID</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Customer</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Email</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Phone</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Address</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Total (₵)</th>
          <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">Status</th>
          <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100" id="ordersBody">
        {% for o in orders %}
        <tr data-order-id="{{ o.order_id }}" data-status="{{ o.status }}">
          <td class="px-4 py-3">{{ o.order_id }}</td>
          <td class="px-4 py-3">{{ o.user_name }}</td>
          <td class="px-4 py-3">{{ o.email }}</td>
          <td class="px-4 py-3">{{ o.phone or '-' }}</td>
          <td class="px-4 py-3">{{ o.address or '-' }}</td>
          <td class="px-4 py-3">{{ '%.2f'|format(o.total) }}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded-full text-xs font-medium 
              {% if o.status == 'Completed' %} bg-green-100 text-green-700
              {% elif o.status == 'Pending' %} bg-yellow-100 text-yellow-700
              {% elif o.status == 'Processing' %} bg-indigo-100 text-indigo-700
              {% else %} bg-red-100 text-red-700 {% endif %}">
              {{ o.status }}
            </span>
          </td>
          <td class="px-4 py-3 text-center">
            <button class="text-blue-600 hover:underline" onclick="viewOrder('{{ o.order_id }}')">View</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls -->
  <div class="mt-4 flex items-center justify-between">
    <div>
      <button id="prevPage" class="px-3 py-1 border rounded mr-2">Previous</button>
      <button id="nextPage" class="px-3 py-1 border rounded">Next</button>
    </div>
    <div class="text-sm text-gray-600">Page <span id="currentPage">1</span> of <span id="pageCount">1</span></div>
  </div>
  <!-- Order detail modal -->
  <div id="orderModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
    <div class="bg-white w-full max-w-3xl rounded-lg shadow-xl overflow-auto">
      <div class="p-4 border-b flex items-start justify-between">
        <div>
          <h3 id="modalOrderTitle" class="text-lg font-semibold">Order #<span id="modalOrderId"></span></h3>
          <div id="modalOrderCreated" class="text-sm text-gray-500"></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="modalCancelBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:opacity-90">Cancel Order</button>
          <button id="modalCloseBtn" class="text-gray-600 px-3 py-1 rounded hover:bg-gray-100">Close</button>
        </div>
      </div>
      <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <h4 class="text-sm font-medium text-gray-700">Customer</h4>
          <div id="modalCustomerName" class="text-sm text-gray-800"></div>
          <div id="modalCustomerEmail" class="text-sm text-gray-600"></div>
          <div id="modalCustomerPhone" class="text-sm text-gray-600"></div>
          <div id="modalCustomerAddress" class="text-sm text-gray-600 mt-2"></div>
        </div>
        <div>
          <h4 class="text-sm font-medium text-gray-700">Summary</h4>
          <div class="flex items-center justify-between mt-2"><div class="text-sm text-gray-600">Status</div><div id="modalStatus" class="text-sm font-medium"></div></div>
          <div class="flex items-center justify-between mt-2"><div class="text-sm text-gray-600">Total</div><div id="modalTotal" class="text-sm font-bold"></div></div>
        </div>
      </div>
      <div class="p-4 border-t">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Items</h4>
        <ul id="modalItems" class="space-y-3"></ul>
      </div>
    </div>
  </div>

</section>

<script>
function viewOrder(orderId) {
  // fetch order details and show modal
  (async function(){
    try{
      const res = await fetch(`/admin/api/orders/${orderId}`);
      if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        window.showToast ? window.showToast(err.message || 'Failed to load order', 'error') : alert('Failed to load order');
        return;
      }
      const data = await res.json();
      // populate modal
      document.getElementById('modalOrderId').textContent = data.order_id;
      document.getElementById('modalOrderTitle').dataset.orderId = data.order_id;
      document.getElementById('modalOrderCreated').textContent = data.created_at ? new Date(data.created_at).toLocaleString() : '';
      document.getElementById('modalCustomerName').textContent = data.user?.name || '';
      document.getElementById('modalCustomerEmail').textContent = data.user?.email || '';
      document.getElementById('modalCustomerPhone').textContent = data.user?.phone || '';
      document.getElementById('modalCustomerAddress').textContent = data.user?.address || '';
      document.getElementById('modalTotal').textContent = '₵' + (Number(data.total_amount||0)).toFixed(2);

      const statusEl = document.getElementById('modalStatus');
      statusEl.textContent = data.status || '';
      // set status badge style
      function statusClassFor(s){
        if (!s) return 'text-sm';
        if (s === 'Completed') return 'px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700';
        if (s === 'Pending') return 'px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700';
        if (s === 'Processing') return 'px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700';
        return 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700';
      }
      statusEl.className = statusClassFor(data.status);

      const itemsEl = document.getElementById('modalItems');
      itemsEl.innerHTML = '';
      (data.items||[]).forEach(i => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between';
        li.innerHTML = `<div class="flex items-center gap-3"><div class="text-sm font-medium">${i.name||'(deleted)'}</div><div class="text-xs text-gray-500">Qty: ${i.quantity}</div></div><div class="text-sm">₵${(Number(i.price||0)).toFixed(2)}</div>`;
        itemsEl.appendChild(li);
      });

      // show/hide cancel button depending on status
      const cancelBtn = document.getElementById('modalCancelBtn');
      if (data.status === 'Completed' || data.status === 'Cancelled'){
        cancelBtn.disabled = true;
        cancelBtn.classList.add('opacity-50','cursor-not-allowed');
      } else {
        cancelBtn.disabled = false;
        cancelBtn.classList.remove('opacity-50','cursor-not-allowed');
      }

      // attach cancel handler
      cancelBtn.onclick = async function(){
        if (!confirm('Are you sure you want to cancel this order? This action will update the database.')) return;
        try{
          const r2 = await fetch(`/admin/api/orders/${orderId}/cancel`, { method: 'POST' });
          const j = await r2.json().catch(()=>({}));
          if (!r2.ok){
            window.showToast ? window.showToast(j.message || 'Failed to cancel order', 'error') : alert(j.message || 'Failed to cancel order');
            return;
          }
          window.showToast ? window.showToast('Order cancelled', 'success') : alert('Order cancelled');
          // update row in table
          const row = document.querySelector(`tr[data-order-id="${orderId}"]`);
          if (row){
            row.dataset.status = 'Cancelled';
            const badge = row.querySelector('td:nth-child(7) > span');
            if (badge){ badge.textContent = 'Cancelled'; badge.className = 'px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-700'; }
          }
          // update modal status
          statusEl.textContent = 'Cancelled';
          statusEl.className = statusClassFor('Cancelled');
          cancelBtn.disabled = true;
          cancelBtn.classList.add('opacity-50','cursor-not-allowed');
        }catch(err){ console.error(err); window.showToast ? window.showToast('Network error cancelling order', 'error') : alert('Network error'); }
      };

      // open modal
      const modal = document.getElementById('orderModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }catch(err){ console.error(err); window.showToast ? window.showToast('Error loading order', 'error') : alert('Error loading order'); }
  })();
}

// Client-side filtering, pagination and export
(function(){
  const table = document.getElementById('ordersTable');
  const body = document.getElementById('ordersBody');
  const rows = Array.from(body.querySelectorAll('tr'));
  const totalCountEl = document.getElementById('totalCount');
  const visibleCountEl = document.getElementById('visibleCount');
  const searchInput = document.getElementById('ordersSearch');
  const statusFilter = document.getElementById('statusFilter');
  const pageSizeSelect = document.getElementById('pageSize');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const currentPageEl = document.getElementById('currentPage');
  const pageCountEl = document.getElementById('pageCount');
  const exportBtn = document.getElementById('exportCsv');

  let page = 1;
  let pageSize = Number(pageSizeSelect.value || 10);
  let filtered = rows.slice();

  function normalizeText(s){ return (s||'').toString().toLowerCase(); }

  function applyFilters(){
    const q = normalizeText(searchInput.value || '');
    const status = statusFilter.value || '';
    filtered = rows.filter(r => {
      if (status && r.dataset.status !== status) return false;
      if (!q) return true;
      // search across visible cell text
      const text = normalizeText(r.textContent || '');
      return text.indexOf(q) !== -1;
    });
    page = 1;
    render();
  }

  function render(){
    const total = filtered.length;
    totalCountEl.textContent = rows.length;
    visibleCountEl.textContent = total;
    pageSize = Number(pageSizeSelect.value || 10);
    const pageCount = Math.max(1, Math.ceil(total / pageSize));
    if (page > pageCount) page = pageCount;
    pageCountEl.textContent = pageCount;
    currentPageEl.textContent = page;

    // hide all rows then show current page
    rows.forEach(r => r.style.display = 'none');
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    filtered.slice(start, end).forEach(r => r.style.display = 'table-row');

    prevBtn.disabled = page <= 1;
    nextBtn.disabled = page >= pageCount;
  }

  // Pagination handlers
  prevBtn.addEventListener('click', ()=>{ if (page>1) { page--; render(); } });
  nextBtn.addEventListener('click', ()=>{ const pageCount = Math.max(1, Math.ceil(filtered.length / pageSize)); if (page<pageCount) { page++; render(); } });
  pageSizeSelect.addEventListener('change', ()=>{ page = 1; render(); });

  // Filters
  searchInput.addEventListener('input', () => { applyFilters(); });
  statusFilter.addEventListener('change', () => { applyFilters(); });

  // Export visible rows to CSV
  function exportCsv(){
    const visibleRows = filtered;
    const headers = ['order_id','customer','email','phone','address','total','status'];
    const data = [headers.join(',')];
    visibleRows.forEach(r => {
      const cols = Array.from(r.querySelectorAll('td')).map(td => '"'+(td.textContent||'').trim().replace(/"/g,'""')+'"');
      data.push(cols.join(','));
    });
    const csv = data.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'orders-export.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  exportBtn.addEventListener('click', exportCsv);

  // initial render
  applyFilters();
})();

// Modal close handlers
(function(){
  const modal = document.getElementById('orderModal');
  const closeBtn = document.getElementById('modalCloseBtn');
  if (!modal) return;
  function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
  closeBtn && closeBtn.addEventListener('click', closeModal);
  // close when clicking outside content
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
})();
</script>

{% endblock %}
