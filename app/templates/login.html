{% extends 'base.html' %}
{% block title %}Sign in | Hunch√ò.clothing{% endblock %}

{% block content %}

<!-- Defensive fixes for submit button visibility (some external CSS may set buttons transparent) -->
<style>
  /* Ensure the primary submit button is always visible */
  #loginForm button[type="submit"] {
    opacity: 1 !important;
    background-color: #E11D48 !important; /* primary */
    color: #ffffff !important;
    border: none !important;
    box-shadow: 0 1px 0 rgba(0,0,0,0.04) !important;
    z-index: 2 !important;
  }
  /* Make sure hover state is consistent */
  #loginForm button[type="submit"]:hover {
    background-color: #dc163f !important; /* slightly darker */
    opacity: 1 !important;
  }
</style>

<!-- Modern split sign-in layout inspired by reference -->
<div class="w-full max-w-6xl bg-transparent rounded-lg p-4">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-stretch">

    <!-- Left visual promo -->
  <div class="hidden lg:flex rounded-lg overflow-hidden bg-cover bg-center" style="background: linear-gradient(135deg, rgba(225,29,72,0.85), rgba(15,23,42,0.85)), url('{{ url_for('static', filename='images/logo_2.png') }}'); background-size: cover; background-position: center;">
      <div class="p-12 text-white flex flex-col justify-center gap-4">
        <h1 class="text-4xl font-extrabold leading-tight">Welcome back</h1>
        <p class="opacity-90 max-w-md">Sign in to manage your orders, track shipments and access exclusive offers.</p>
        <a href="/shop" class="mt-4 inline-block bg-white text-dark px-4 py-2 rounded font-medium hover:opacity-90">Shop now</a>
      </div>
    </div>

    <!-- Right: sign-in card -->
    <div class="bg-white rounded-lg shadow-md p-8">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-2xl font-semibold text-dark">Sign in to your account</h2>
          <p class="text-sm text-gray-500">Enter your credentials to continue.</p>
        </div>
  <img src="{{ url_for('static', filename='images/logo_2.png') }}" alt="logo" class="h-10 w-auto">
      </div>

  <form id="loginForm" class="space-y-4" data-no-loader="true">
        <div>
          <label class="block text-sm font-medium mb-1">Email</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary" required>
        </div>

        <div class="relative">
          <label class="block text-sm font-medium mb-1">Password</label>
          <input id="password" name="password" type="password" placeholder="Your password" class="w-full border rounded-md px-3 py-3 pr-14 focus:outline-none focus:ring-2 focus:ring-primary" required>
          <button type="button" class="pw-toggle absolute inset-y-0 right-2 flex items-center px-3 text-gray-500 h-full" aria-label="Show password" data-target="#password">
            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
          </button>
        </div>

        <div class="flex items-center justify-between text-sm">
          <label class="flex items-center gap-2">
            <input id="remember" type="checkbox" class="rounded"> Remember me
          </label>
          <a href="/auth/password-reset-request" class="text-primary hover:underline">Forgot password?</a>
        </div>

        <button type="submit" class="w-full bg-primary text-white py-3 rounded-md hover:bg-red-600 transition">Sign in</button>

        <div class="text-center text-sm mt-2">
          Don't have an account? <a href="/auth/register" class="text-primary hover:underline">Create one</a>
        </div>

        <div class="mt-4 text-center">
          <div class="flex items-center gap-3 justify-center">
            <span class="w-24 h-px bg-gray-200"></span>
            <span class="text-xs text-gray-400">Or continue with</span>
            <span class="w-24 h-px bg-gray-200"></span>
          </div>
          <a href="/auth/google/login" class="inline-flex items-center gap-3 mt-3 border rounded-md px-4 py-2 hover:shadow-sm">
            <img src="{{ url_for('static', filename='images/google_logo.png') }}" alt="Google" class="h-5 w-5">
            <span class="text-sm">Sign in with Google</span>
          </a>
        </div>

        <p id="message" class="text-center mt-2 text-sm"></p>
      </form>
    </div>

  </div>
</div>

<script>
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (window.showToast) showToast('Signing in...', 'info', {duration:2000});

  const data = {
    email: document.getElementById('email').value,
    password: document.getElementById('password').value,
    remember: document.getElementById('remember').checked
  };

  try {
    const btn = document.querySelector('#loginForm button[type="submit"]');
    // show small loader on the button
    const showButtonSpinner = (b) => {
      if (!b) return;
      b.disabled = true;
      b.dataset._orig = b.innerHTML;
      b.insertAdjacentHTML('afterbegin', '<span class="btn-spinner mr-2" aria-hidden="true"></span>');
    };
    const hideButtonSpinner = (b) => {
      if (!b) return;
      b.disabled = false;
      // remove spinner
      const s = b.querySelector('.btn-spinner'); if (s) s.remove();
      if (b.dataset._orig) { b.innerHTML = b.dataset._orig; delete b.dataset._orig; }
    };
    showButtonSpinner(btn);

    const res = await fetch(window.location.pathname, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if (window.showToast) showToast(result.message || result.error || '', res.ok ? 'success' : 'error');
    if (res.status === 200) {
      // If server indicates OTP is required for login, redirect user to OTP page
      if (result.otp_required) {
        try { localStorage.setItem('prefill_email', data.email); } catch(e){}
        window.location.href = '/auth/verify-otp?flow=login';
        return;
      }
      try {
        if (result.access_token) localStorage.setItem('access_token', result.access_token);
        if (result.refresh_token) localStorage.setItem('refresh_token', result.refresh_token);
      } catch (e) { console.warn('Could not save tokens', e); }
      // if this user is an admin, navigate to the admin dashboard
      setTimeout(()=> {
        try {
          if (result.is_admin) {
            try { localStorage.setItem('admin_token', result.access_token); } catch(e){}
            window.location.href = '/admin/dashboard';
            return;
          }
        } catch(e){}
        window.location.href = '/';
      }, 700);
    }
  } catch (err) {
    if (window.showToast) showToast('Something went wrong. Please try again.', 'error');
  }
  finally {
    // hide spinner
    const btn = document.querySelector('#loginForm button[type="submit"]');
    if (btn) {
      const s = btn.querySelector('.btn-spinner'); if (s) s.remove();
      if (btn.dataset._orig) { btn.innerHTML = btn.dataset._orig; delete btn.dataset._orig; }
      btn.disabled = false;
    }
  }
});
</script>

{% endblock %}
