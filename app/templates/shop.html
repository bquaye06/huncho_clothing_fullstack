{% extends 'base.html' %}
{% block title %}HunchØ.clothing | Shop{% endblock %}
{% block content %}

<!-- Modern Shop Layout inspired by reference -->
<section class="relative">
  <div class="w-full h-[56vh] lg:h-[64vh] overflow-hidden">
  <div class="w-full h-full hero-shop-bg" style="background-image: url('{{ url_for('static', filename='images/hero.jpg') }}'); background-size: cover; background-position: center; filter: brightness(.55);"></div>
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="text-center text-white">
        <h1 class="text-4xl md:text-6xl font-extrabold tracking-widest">SHOP</h1>
        <p class="mt-4 text-sm md:text-base opacity-90">Curated selection · New drops · Best sellers</p>
      </div>
    </div>
  </div>
</section>

<!-- Top controls and category nav inspired by reference -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <div class="text-xs text-gray-500">SHOP <span class="ml-2 text-gray-900">{{ products|length if products else 0 }}</span></div>
      <nav id="categoryNav" class="mt-4 flex gap-4 text-xs text-gray-500">
        <a href="#" data-cat="all" class="cat-link text-black font-semibold border-b-2 border-black pb-1">ALL</a>
      </nav>
    </div>

    <div class="flex items-center gap-4">
      <div class="relative">
        <button id="filterBtn" class="flex items-center gap-2 border rounded-md px-3 py-2 text-sm hover:bg-gray-100">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10h18M3 16h18"/></svg>
          <span>FILTER</span>
        </button>

        <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white border rounded-md shadow-lg p-4 z-40">
          <div class="space-y-3">
            <label class="flex items-center gap-2 text-sm">
              <input id="saleOnly" type="checkbox" class="form-checkbox" />
              <span>Sale only</span>
            </label>

            <div class="pt-2 border-t">
              <div class="text-xs font-semibold text-gray-600 mb-2">Categories</div>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="caps" /> Caps</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="hoodies" /> Hoodies</label>
              <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="t-shirts" /> T-shirts</label>
            </div>
          </div>
          <div class="mt-3 flex justify-between">
            <button id="applyFilters" class="px-3 py-1 bg-black text-white rounded text-sm">Apply</button>
            <button id="clearFilters" class="px-3 py-1 border rounded text-sm">Clear</button>
          </div>
        </div>
        <!-- Mobile / slide-in filter panel -->
        <div id="filterPanel" class="fixed inset-0 z-50 hidden">
          <div id="filterPanelOverlay" class="absolute inset-0 bg-black/50"></div>
          <div class="absolute right-0 top-0 h-full w-full sm:w-80 bg-white p-6 overflow-auto">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">Filters</h3>
              <button id="closeFilterPanel" class="text-gray-600">✕</button>
            </div>
            <div class="space-y-4">
              <label class="flex items-center gap-2 text-sm">
                <input id="saleOnlyPanel" type="checkbox" class="form-checkbox" />
                <span>Sale only</span>
              </label>
              <div class="pt-2 border-t">
                <div class="text-xs font-semibold text-gray-600 mb-2">Categories</div>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="caps" /> Caps</label>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="hoodies" /> Hoodies</label>
                <label class="flex items-center gap-2 text-sm"><input type="checkbox" class="category-checkbox" data-cat="t-shirts" /> T-shirts</label>
              </div>
            </div>
            <div class="mt-6 flex justify-between">
              <button id="applyFiltersPanel" class="px-4 py-2 bg-black text-white rounded">Apply</button>
              <button id="clearFiltersPanel" class="px-4 py-2 border rounded">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- products grid -->
  {% if products %}
  <div id="productsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-8">
    {% for product in products %}
    <div class="relative group" data-category="{{ (product.category or '')|lower }}" data-price="{{ product.price }}" data-color="{{ (product.color or '')|lower }}" data-sale="{{ 'true' if (product.original_price and product.original_price > product.price) else 'false' }}">
      <!-- small badges and quick-add icon -->
      <div class="absolute top-3 left-3 z-10">
        {% if product.original_price and product.original_price > product.price %}
        <span class="bg-gray-100 text-xs text-gray-700 px-2 py-1 rounded-full">SALE</span>
        {% endif %}
      </div>
      <button class="absolute top-3 right-3 z-10 w-8 h-8 bg-white rounded border flex items-center justify-center opacity-0 group-hover:opacity-100 transition">+
      </button>

  <a href="{{ url_for('products_bp.product_detail_page', name=product.name) }}" class="block text-center">
        <div class="w-full h-64 flex items-center justify-center">
          {# support full URLs or absolute paths stored in DB, otherwise fall back to static/products filename #}
          {% set imgval = (product.image_url or '') %}
          {% if imgval.startswith('http') or imgval.startswith('/') %}
            <img src="{{ imgval }}" alt="{{ product.name }}" title="{{ imgval }}" class="max-h-56 object-contain transition-transform group-hover:scale-105" onerror="this.onerror=null;this.src=window._STATIC.dress" />
          {% else %}
            <img src="{{ url_for('static', filename='images/products/' ~ (imgval if imgval else 'dress.webp')) }}" alt="{{ product.name }}" title="{{ imgval }}" class="max-h-56 object-contain transition-transform group-hover:scale-105" onerror="this.onerror=null;this.src=window._STATIC.dress" />
          {% endif %}
        </div>
        <div class="mt-4 text-left px-1">
          <div class="text-xs uppercase text-gray-700 font-medium">{{ product.name }}</div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-xs text-gray-500">{{ product.color if product.color else 'BLACK' }}</div>
            <div class="text-sm font-semibold">₵{{ '%.2f'|format(product.price) }}</div>
          </div>
        </div>
      </a>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p class="text-center text-gray-500 text-lg mt-20">No products available yet.</p>
  {% endif %}
</section>

<style>
  /* product grid styling to match referenced layout */
  .group-hover\:scale-105 { transition: transform .45s cubic-bezier(.2,.9,.2,1); }
  img.object-contain { max-width: 100%; }
</style>

{% endblock %}
 
<script>
// Client-side filtering for shop
;(function(){
  const categoryLinks = Array.from(document.querySelectorAll('.cat-link'));
  const productsGrid = document.getElementById('productsGrid');
  const productCards = productsGrid ? Array.from(productsGrid.children) : [];
  const categoryCheckboxes = Array.from(document.querySelectorAll('.category-checkbox'));
  const filterBtn = document.getElementById('filterBtn');
  const filterDropdown = document.getElementById('filterDropdown');
  const saleOnlyEl = document.getElementById('saleOnly');
  const applyBtn = document.getElementById('applyFilters');
  const clearBtn = document.getElementById('clearFilters');

  let activeCategory = 'all';
  let saleOnly = false;
  let selectedCategories = [];

  function applyFilters(){
    productCards.forEach(card => {
      const cat = (card.getAttribute('data-category') || '').toLowerCase();
      const isSale = card.getAttribute('data-sale') === 'true';

      let visible = true;
      // apply nav activeCategory (legacy single-cat filter)
      if (activeCategory && activeCategory !== 'all'){
        if (activeCategory === 'sale') {
          if (!isSale) visible = false;
        } else if (cat.indexOf(activeCategory) === -1) {
          visible = false;
        }
      }
      // apply selected category checkboxes (multi-select). If any selected, product must match one of them.
      if (selectedCategories.length > 0) {
        const matches = selectedCategories.some(sc => (cat.indexOf(sc) !== -1));
        if (!matches) visible = false;
      }
      if (saleOnly && !isSale) visible = false;

      card.style.display = visible ? '' : 'none';
    });
  }

  // category link clicks
  categoryLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const cat = link.getAttribute('data-cat') || 'all';
      activeCategory = cat.toLowerCase();

      // update active styles
      categoryLinks.forEach(l => l.classList.remove('text-black','font-semibold','border-b-2','border-black','pb-1'));
      link.classList.add('text-black','font-semibold','border-b-2','border-black','pb-1');

      applyFilters();
    });
  });

  // filter dropdown toggle (open/close)
  if (filterBtn && filterDropdown){
    filterBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      // on small screens, open the slide-in panel instead
      if (window.innerWidth < 640) {
        const panel = document.getElementById('filterPanel');
        if (panel) panel.classList.remove('hidden');
        document.documentElement.classList.add('overflow-hidden');
        return;
      }
      filterDropdown.classList.toggle('hidden');
    });
    // close when clicking outside (ignore clicks inside filter button or dropdown)
    document.addEventListener('click', (e) => {
      const target = e.target;
      const clickedInsideDropdown = filterDropdown.contains(target);
      const clickedInsideBtn = filterBtn.contains(target);
      if (!clickedInsideDropdown && !clickedInsideBtn) {
        filterDropdown.classList.add('hidden');
      }
    });
    // panel close buttons
    const filterPanel = document.getElementById('filterPanel');
    if (filterPanel){
      const overlay = document.getElementById('filterPanelOverlay');
      const closeBtn = document.getElementById('closeFilterPanel');
      function closePanel(){ filterPanel.classList.add('hidden'); document.documentElement.classList.remove('overflow-hidden'); }
      overlay && overlay.addEventListener('click', closePanel);
      closeBtn && closeBtn.addEventListener('click', closePanel);
      // wire panel apply/clear to reuse same logic
      const applyPanel = document.getElementById('applyFiltersPanel');
      const clearPanel = document.getElementById('clearFiltersPanel');
      const saleOnlyPanel = document.getElementById('saleOnlyPanel');
      if (applyPanel){
        applyPanel.addEventListener('click', (e) => {
          saleOnly = !!(saleOnlyPanel && saleOnlyPanel.checked);
          selectedCategories = Array.from(filterPanel.querySelectorAll('.category-checkbox')).filter(cb => cb.checked).map(cb => (cb.getAttribute('data-cat')||'').toLowerCase()).filter(Boolean);
          closePanel();
          applyFilters();
        });
      }
      if (clearPanel){
        clearPanel.addEventListener('click', (e) => {
          // clear panel inputs and global state
          (saleOnlyPanel && (saleOnlyPanel.checked = false));
          Array.from(filterPanel.querySelectorAll('.category-checkbox')).forEach(cb => cb.checked = false);
          saleOnly = false; selectedCategories = [];
          closePanel(); applyFilters();
        });
      }
    }
  }

  if (applyBtn){
    applyBtn.addEventListener('click', (e) => {
      saleOnly = !!saleOnlyEl.checked;
      // collect selected categories from checkboxes
      selectedCategories = categoryCheckboxes.filter(cb => cb.checked).map(cb => (cb.getAttribute('data-cat') || '').toLowerCase()).filter(Boolean);
      filterDropdown.classList.add('hidden');
      applyFilters();
    });
  }

  if (clearBtn){
    clearBtn.addEventListener('click', (e) => {
      saleOnly = false;
      saleOnlyEl.checked = false;
      activeCategory = 'all';
      selectedCategories = [];
      categoryCheckboxes.forEach(cb => cb.checked = false);
      // reset active link styles
      categoryLinks.forEach(l => l.classList.remove('text-black','font-semibold','border-b-2','border-black','pb-1'));
      const allLink = document.querySelector('[data-cat="all"]'); if (allLink) allLink.classList.add('text-black','font-semibold','border-b-2','border-black','pb-1');
      applyFilters();
    });
  }

  // initial setup: set ALL active
  const allLinkInit = document.querySelector('[data-cat="all"]'); if (allLinkInit) allLinkInit.classList.add('text-black','font-semibold','border-b-2','border-black','pb-1');
  // expose for debugging
  window._shopFilters = { applyFilters };
})();
</script>
